name: PR Validation

on:
  pull_request:
    paths:
      - '**/*.usd*'

jobs:
  run-usdchecker:
    name: Run usdchecker
    runs-on: ubuntu-22.04

    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v37
      with:
        files: |
          **/*.usd*
        files_ignore_from_source_file: .github/usdchecker-skiplist.txt

    - name: Install usd-core PyPI package
      run: pip install usd-core==24.11 requests --user

    - name: Test usdchecker
      run: python .github/usdchecker.py --help

    - name: Run usdchecker on changed USD files
      env:
        SENTINEL_WORKSPACE_ID: ${{ secrets.SENTINEL_WORKSPACE_ID }}
        SENTINEL_SHARED_KEY: ${{ secrets.SENTINEL_SHARED_KEY }}
      run: |
        set +e
        exit_code=0
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking $file"
            if ! python .github/usdchecker.py $file; then
                exit_code=1;
                python .github/sentinel_logger.py "Failed" "USD Compliance Check Failed" "$file"
            else
                python .github/sentinel_logger.py "Success" "USD Compliance Check Passed" "$file"
            fi
        done
        exit $exit_code
